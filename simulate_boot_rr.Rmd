---
title: "Simulate Bootstrapped Model"
author: "Erin M. Buchanan"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Libraries

```{r libraries}
library(papaja)
library(lavaan)
library(broom)
library(dplyr)
library(ggplot2)
library(cowplot)
library(ggridges)
library(tidyr)
library(rio)

# devtools::install_github("psyteachr/introdataviz")
# devtools::install_github("ddueber/dmacs")
# devtools::install_github("doomlab/visualizemi")
library(introdataviz)
library(dmacs)
library(visualizemi)
set.seed(84393)
```

## Simulate Bootstraps

```{r create-models}
# overall model
model.overall <- "lv =~ q1 + q2 + q3 + q4 + q5
q1 ~ 0*1
lv ~ 1"

# build invariant model one factor
model.invariant.g1 <- "lv =~ .8*q1 + .4*q2 + .6*q3 + .3*q4 + .6*q5 
q4 ~~ 1*q4
q4 ~ 0*1
q1 ~ 0*1
lv ~ 1"
model.invariant.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .31*q4 + .61*q5
q4 ~~ 1*q4
q4 ~ 0*1
q1 ~ 0*1
lv ~ 1"

# loadings .5, .8, 1.1
model.small.load.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .5*q4 + .61*q5
q1 ~ 0*1
lv ~ 1"
model.med.load.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .8*q4 + .61*q5
q1 ~ 0*1
lv ~ 1"
model.large.load.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + 1.1*q4 + .61*q5
q1 ~ 0*1
lv ~ 1"

# build invariance on intercepts .25, .50, and .75
model.small.int.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .31*q4 + .61*q5
q4 ~ .25*1
q1 ~ 0*1
lv ~ 1"
model.med.int.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .31*q4 + .61*q5
q4 ~ .5*1
q1 ~ 0*1
lv ~ 1"
model.large.int.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .31*q4 + .61*q5
q4 ~ .75*1
q1 ~ 0*1
lv ~ 1"

# build invariance on residuals .25, .50, and .75
model.small.res.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .31*q4 + .61*q5
q4 ~~ .75*q4
q1 ~ 0*1
lv ~ 1"
model.med.res.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .31*q4 + .61*q5
q4 ~~ .5*q4
q1 ~ 0*1
lv ~ 1"
model.large.res.g2 <- "lv =~ .81*q1 + .41*q2 + .61*q3 + .31*q4 + .61*q5
q4 ~~ .25*q4
q1 ~ 0*1
lv ~ 1"
```

```{r boot-loop}
# a place to hold stuff
boot_rr_loop <- list()

for (i in 14:100){
  
    set.seed(round(abs(rnorm(1)*100)))
  df.invariant <- df.small.load <- df.med.load <- df.large.load <- 
    df.small.int <- df.med.int <- df.large.int <- df.small.res <- 
    df.med.res <- df.large.res <-   
    results.invariant <- results.small.load <- results.med.load <- results.large.load <- 
    results.small.int <- results.med.int <- results.large.int <- results.small.res <- 
    results.med.res <- results.large.res <-   
    boot.invariant <- boot.small.load <- boot.med.load <- boot.large.load <- 
    boot.small.int <- boot.med.int <- boot.large.int <- boot.small.res <- 
    boot.med.res <- boot.large.res <- NULL

  # create data ----
    # simulate data invariant
    df.invariant <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.invariant.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data small load
    df.small.load <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.small.load.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data med load
    df.med.load <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.med.load.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data large load
    df.large.load <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.large.load.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data small int
    df.small.int <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.small.int.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data med int
    df.med.int <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.med.int.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data large int
    df.large.int <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.large.int.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data small res
    df.small.res <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.small.res.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data med res
    df.med.res <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.med.res.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )
    
    # simulate data large res
    df.large.res <- bind_rows(
      simulateData(model.invariant.g1, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 1"), 
      simulateData(model.large.res.g2, sample.nobs = 250, 
                   meanstructure = T, model.type = "cfa"
                   ) %>% 
        mutate(group = "Group 2") 
    )

  # run the cfas -----
    # invariant CFA
    results.invariant <- 
      mgcfa(model = model.overall, 
            data = df.invariant,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    
    # loadings
    results.small.load <- 
      mgcfa(model = model.overall, 
            data = df.small.load,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    
    results.med.load <- 
      mgcfa(model = model.overall, 
            data = df.med.load,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    results.large.load <- 
      mgcfa(model = model.overall, 
            data = df.large.load,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    
    # intercepts
    results.small.int <- 
      mgcfa(model = model.overall, 
            data = df.small.int,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    results.med.int <- 
      mgcfa(model = model.overall, 
            data = df.med.int,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    results.large.int <- 
      mgcfa(model = model.overall, 
            data = df.large.int,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    
    # residuals
    results.small.res <-
      mgcfa(model = model.overall, 
            data = df.small.res,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    results.med.res <- 
      mgcfa(model = model.overall, 
            data = df.med.res,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
    results.large.res <- 
      mgcfa(model = model.overall, 
            data = df.large.res,
            group = "group",
            group.equal = c("loadings", "intercepts", "residuals"),
            meanstructure = T)
  
  # calculate bootstraps -----
    boot.model.invariant <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.invariant$model_configural,
        # dataframe
        data = df.invariant,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Invariant")
    
    boot.model.small.load <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.small.load$model_configural,
        # dataframe
        data = df.small.load,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Small Loadings")
    
    boot.model.med.load <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.med.load$model_configural,
        # dataframe
        data = df.med.load,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Medium Loadings")
    
    boot.model.large.load <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.large.load$model_configural,
        # dataframe
        data = df.large.load,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Large Loadings")
    
    boot.model.small.int <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.small.int$model_configural,
        # dataframe
        data = df.small.int,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Small Intercepts")
    
    boot.model.med.int <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.med.int$model_configural,
        # dataframe
        data = df.med.int,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Medium Intercepts")
    
    boot.model.large.int <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.large.int$model_configural,
        # dataframe
        data = df.large.int,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Large Intercepts")
    
    boot.model.small.res <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.small.res$model_configural,
        # dataframe
        data = df.small.res,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Small Residuals")
    
    boot.model.med.res <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.med.res$model_configural,
        # dataframe
        data = df.med.res,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Medium Residuals")
    
    boot.model.large.res <- 
      bootstrap_rr(
        # saved configural model 
        saved_configural = results.large.res$model_configural,
        # dataframe
        data = df.large.res,
        # model syntax
        model = model.overall, 
        # group variable column in dataframe
        group = "group",
        # number of bootstraps
        nboot = 1000, 
        # which fit index you would like to use
        invariance_index = "cfi",
        # what is your criterion for that fit index
        invariance_rule = .01,
        # what equality constraints are you testing 
        group.equal = c("loadings", "intercepts", "residuals")
      ) %>% 
      mutate(type = "Large Residuals")
    
    boot_rr_loop[[i]] <- bind_rows(
      boot.model.invariant,
      boot.model.small.load,
      boot.model.med.load,
      boot.model.large.load,
      boot.model.small.int,
      boot.model.med.int,
      boot.model.large.int,
      boot.model.small.res,
      boot.model.med.res,
      boot.model.large.res
    ) %>% 
      mutate(run_number = i)
    
    cat(i)
    cat("\n")
    cat(Sys.time())
    
    boot_rr_DF <- bind_rows(boot_rr_loop)

    export(boot_rr_DF, paste0("data/boot_rr_DF_",i,".csv"), row.names = F)
}


```
